/* angular-resource-watcher - v0.0.2 - 2015-11-20 */
"use strict";var rw,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};rw=angular.module("resource.watcher",["ngResource"]).factory("resource",function(a,b){var c,d,e,f,g;return g=function(a){return _.omit(a,function(a,b){return 0===b.indexOf("_")})},c=function(){function a(a){this.previousState=a,this._deleteAddedProperties=__bind(this._deleteAddedProperties,this),this.rollback=__bind(this.rollback,this)}return a.prototype.save=function(a,b,c){return a.executeSave(b,c)},a.prototype.isDirty=function(){return!0},a.prototype.rollback=function(a){return this._deleteAddedProperties(a),a.updateValuesWith(this.previousState),a.setAsPristine()},a.prototype._deleteAddedProperties=function(a){var b,c;return c=function(b){return _.omit(g(a),_.isFunction)},b=_.difference(_.keys(c(a)),_.keys(this.previousState)),b.forEach(function(b){return delete a[b]})},a}(),f=function(){function b(){}return b.prototype.save=function(){return a.when()},b.prototype.isDirty=function(){return!1},b.prototype.rollback=function(){},b}(),d=function(){function a(){this.executeSave=__bind(this.executeSave,this),this.setAsDirty=__bind(this.setAsDirty,this),this.setAsPristine=__bind(this.setAsPristine,this),this.rollback=__bind(this.rollback,this),this.isDirty=__bind(this.isDirty,this),this.save=__bind(this.save,this),this._state=new f}return a.prototype.save=function(a,b){return this._state.save(this,a,b)},a.prototype["delete"]=function(a,b){return a.sendDelete(b)},a.prototype.isNew=function(){return!1},a.prototype.isDirty=function(){return this._state.isDirty()},a.prototype.rollback=function(a){return this._state.rollback(a)},a.prototype.setAsPristine=function(){return this._state=new f},a.prototype.setAsDirty=function(a){return this._state=new c(a)},a.prototype.executeSave=function(a,b){return a.sendPut(b).then(function(a){return function(b){return a.setAsPristine(),b}}(this))},a}(),e=function(b){function d(){this._state=new c}return __extends(d,b),d.prototype["delete"]=function(){return a.when()},d.prototype.isNew=function(){return!0},d.prototype.isDirty=function(){return!0},d.prototype.rollback=function(){throw new Error("can_not_rollback_a_new_resource")},d.prototype.executeSave=function(a,b){return a.sendPost(b).then(function(b){return a.setAsExisting(b.id),b})},d}(d),function(a,c,f){var h,i,j,k,l,m;return null==c&&(c={}),null==f&&(f={}),m=function(a){return JSON.stringify(g(a))},k={update:{method:"PUT",transformRequest:m},save:{method:"POST",transformRequest:m}},_.assign(k,f),l=_.assign({id:"@id"},c),i=b(a,l,k),h=function(){function a(a){this.sendDelete=__bind(this.sendDelete,this),this.sendPut=__bind(this.sendPut,this),this.sendPost=__bind(this.sendPost,this),this.updateValuesWith=__bind(this.updateValuesWith,this),this.rollback=__bind(this.rollback,this),this.isDirty=__bind(this.isDirty,this),this.setAsPristine=__bind(this.setAsPristine,this),this.setAsDirty=__bind(this.setAsDirty,this),this.isNew=__bind(this.isNew,this),this.setAsExisting=__bind(this.setAsExisting,this),this["delete"]=__bind(this["delete"],this),this.save=__bind(this.save,this),this._state=this._isExisting(a)?new d:new e,this.updateValuesWith(new i(a))}return a.prototype._isExisting=function(a){return null!=a?a.id:void 0},a.prototype.save=function(a){return this._state.save(this,a).then(function(){return this})},a.prototype["delete"]=function(a){return this._state["delete"](this,a)},a.prototype.setAsExisting=function(a){return this.id=a,this._state=new d},a.prototype.isNew=function(){return this._state.isNew()},a.prototype.setAsDirty=function(a){return null==a&&(a={}),this._state.setAsDirty(a)},a.prototype.setAsPristine=function(){return this._state.setAsPristine()},a.prototype.isDirty=function(){return this._state.isDirty()},a.prototype.rollback=function(){return this._state.rollback(this)},a.prototype.updateValuesWith=function(a){return _.assign(_.assign(this,a),Object.getPrototypeOf(a))},a.prototype.sendPost=function(a){return i.save(a,this).$promise},a.prototype.sendPut=function(a){return i.update(a,this).$promise},a.prototype.sendDelete=function(a){return i["delete"](a,this).$promise},a}(),_.assign(h,i),j=function(a,b){return new a(b)},h.get=function(a){return i.get(a).$promise.then(function(a){return function(b){return j(a,b)}}(this))},h.query=function(a){return i.query(a).$promise.then(function(a){return function(b){return b.map(function(b){return j(a,b)})}}(this))},h}});var __bind=function(a,b){return function(){return a.apply(b,arguments)}};rw.factory("CollectionWatcher",function(a,b){var c;return c=function(){function c(a,b){this.scope=a,this.collection=b,this._getOrCreateResourceWatcher=__bind(this._getOrCreateResourceWatcher,this),this._watchResource=__bind(this._watchResource,this),this._saveResource=__bind(this._saveResource,this),this._rollbackResources=__bind(this._rollbackResources,this),this._createResourceWatcher=__bind(this._createResourceWatcher,this),this.createAndAddResourceWatcher=__bind(this.createAndAddResourceWatcher,this),this.watch=__bind(this.watch,this),this.isNew=__bind(this.isNew,this),this.isDirty=__bind(this.isDirty,this),this.save=__bind(this.save,this),this.cancel=__bind(this.cancel,this),this.resourceWatchers=this.collection.map(function(a){return function(b){return a._createResourceWatcher(b)}}(this))}return c.prototype.cancel=function(){return _.remove(this.collection,function(a){return function(a){return a.isNew()}}(this)),this._rollbackResources()},c.prototype.save=function(a){var c;return c=this.collection.map(_.partial(this._saveResource,a)),b.all(c)},c.prototype.isDirty=function(){return _.some(this.collection,function(a){return function(a){return a.isDirty()}}(this))},c.prototype.isNew=function(){return _.some(this.collection,function(a){return function(a){return a.isNew()}}(this))},c.prototype.watch=function(){return this.resourceWatchers.forEach(function(a){return function(a){return a.watch()}}(this))},c.prototype.createAndAddResourceWatcher=function(a){var b;return b=this._createResourceWatcher(a),this.resourceWatchers.push(b),b},c.prototype._createResourceWatcher=function(b){return new a(this.scope,b)},c.prototype._rollbackResources=function(){return this.collection.forEach(function(a){return function(a){return a.rollback()}}(this)),this.watch()},c.prototype._saveResource=function(a,b){return b.save(a).then(function(a){return function(){return a._watchResource(b)}}(this))},c.prototype._watchResource=function(a){return this._getOrCreateResourceWatcher(a).watch()},c.prototype._getOrCreateResourceWatcher=function(a){var b;return b=_.find(this.resourceWatchers,function(b){return b.resource===a}),b||(b=this.createAndAddResourceWatcher(a)),b},c}()});var __bind=function(a,b){return function(){return a.apply(b,arguments)}};rw.factory("ResourceWatcher",function(){var a;return a=function(){function a(a,b){this.scope=a,this.watchedResource=b,this.isNew=__bind(this.isNew,this),this.isDirty=__bind(this.isDirty,this),this.save=__bind(this.save,this),this.cancel=__bind(this.cancel,this),this.watch=__bind(this.watch,this),this.watch()}return a.prototype.watch=function(){var a;return a=this.scope.$watch(function(a){return function(){return a.watchedResource}}(this),function(b){return function(c,d){return c!==d?(b.watchedResource.setAsDirty(d),a()):void 0}}(this),!0)},a.prototype.cancel=function(){return this.watchedResource.rollback(),this.watch()},a.prototype.save=function(a){return this.watchedResource.save(a).then(this.watch)},a.prototype.isDirty=function(){return this.watchedResource.isDirty()},a.prototype.isNew=function(){return this.watchedResource.isNew()},a}()}),rw.constant("watcherConfig",{save:"Guardar",cancel:"Cancelar"}),rw.directive("watcher",function(a,b,c,d){var e;return e='<div ng-show="isDirty()">\n  <input type="submit" ng-value="saveLabel" class="btn btn-primary"/><a href="" ng-click="cancel()" class="cancel-link">{{ cancelLabel }}</a>\n</div>',{template:e,restrict:"E",replace:!0,scope:!0,controller:function(b,c){return this.addWatcher=function(a){return b.watcher=a},b.saveLabel=a.save,b.cancelLabel=a.cancel,b.cancel=function(){return b.watcher.cancel()},b.isDirty=function(){return b.watcher.isDirty()},b.isNew=function(){return b.watcher.isNew()},b.$on("save",function(a,c){return b.watcher.save(c)})}}}).directive("watchResource",function(a,b){return{restrict:"A",require:"^watcher",scope:!1,link:function(c,d,e,f){var g;return g=b(e.watchResource)(c),f.addWatcher(new a(c,g))}}}).directive("watchResourceCollection",function(a,b){return{restrict:"A",scope:!1,require:"^watcher",link:function(c,d,e,f){var g;return g=b(e.watchResourceCollection)(c),f.addWatcher(new a(c,g))}}}).directive("customWatch",function(a){return{restrict:"A",scope:!1,require:"^watcher",link:function(b,c,d,e){return e.addWatcher(a(d.customWatch)(b))}}}).directive("watcherSubmit",function(a){return{restrict:"A",require:"form",scope:!1,link:function(b,c,d,e){return e.attempt=!1,c.bind("submit",function(){return e.attempt=!0,b.$$phase||b.$apply(),e.$valid?b.$broadcast("save",a(d.watcherSubmit)(b)):void 0})}}});