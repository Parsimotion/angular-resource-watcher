/* angular-resource-watcher - v0.1.2 - 2017-12-28 */
"use strict";var rw,bind=function(a,b){return function(){return a.apply(b,arguments)}},extend=function(a,b){function c(){this.constructor=a}for(var d in b)hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},hasProp={}.hasOwnProperty;rw=angular.module("resource.watcher",["ngResource"]).factory("resource",function(a,b){var c,d,e,f,g;return g=function(a){return _.omitBy(a,function(a,b){return 0===b.indexOf("_")})},c=function(){function a(a){this.previousState=a,this._deleteAddedProperties=bind(this._deleteAddedProperties,this),this.rollback=bind(this.rollback,this)}return a.prototype.save=function(a,b,c){return a.executeSave(b,c)},a.prototype.isDirty=function(){return!0},a.prototype.rollback=function(a){return this._deleteAddedProperties(a),a.updateValuesWith(this.previousState),a.setAsPristine()},a.prototype._deleteAddedProperties=function(a){var b,c;return c=function(b){return _.omitBy(g(a),_.isFunction)},b=_.difference(_.keys(c(a)),_.keys(this.previousState)),b.forEach(function(b){return delete a[b]})},a}(),f=function(){function b(){}return b.prototype.save=function(){return a.when()},b.prototype.isDirty=function(){return!1},b.prototype.rollback=function(){},b}(),d=function(){function a(){this.executeSave=bind(this.executeSave,this),this.setAsDirty=bind(this.setAsDirty,this),this.setAsPristine=bind(this.setAsPristine,this),this.rollback=bind(this.rollback,this),this.isDirty=bind(this.isDirty,this),this.save=bind(this.save,this),this._state=new f}return a.prototype.save=function(a,b){return this._state.save(this,a,b)},a.prototype.delete=function(a,b){return a.sendDelete(b)},a.prototype.isNew=function(){return!1},a.prototype.isDirty=function(){return this._state.isDirty()},a.prototype.rollback=function(a){return this._state.rollback(a)},a.prototype.setAsPristine=function(){return this._state=new f},a.prototype.setAsDirty=function(a){return this._state=new c(a)},a.prototype.executeSave=function(a,b){return a.sendPut(b).then(function(a){return function(b){return a.setAsPristine(),b}}(this))},a}(),e=function(b){function d(){this._state=new c}return extend(d,b),d.prototype.delete=function(){return a.when()},d.prototype.isNew=function(){return!0},d.prototype.isDirty=function(){return!0},d.prototype.rollback=function(){throw new Error("can_not_rollback_a_new_resource")},d.prototype.executeSave=function(a,b){return a.sendPost(b).then(function(b){return a.setAsExisting(b.id),b})},d}(d),function(a,c,f){var h,i,j,k,l;return null==c&&(c={}),null==f&&(f={}),l=function(a){return JSON.stringify(g(a))},j={update:{method:"PUT",transformRequest:l},save:{method:"POST",transformRequest:l}},_.assign(j,f),k=_.assign({id:"@id"},c),i=b(a,k,j),h=function(){function a(a){this.toDto=bind(this.toDto,this),this.sendDelete=bind(this.sendDelete,this),this.sendPut=bind(this.sendPut,this),this.sendPost=bind(this.sendPost,this),this.updateValuesWith=bind(this.updateValuesWith,this),this.setValuesWith=bind(this.setValuesWith,this),this.rollback=bind(this.rollback,this),this.isDirty=bind(this.isDirty,this),this.setAsPristine=bind(this.setAsPristine,this),this.setAsDirty=bind(this.setAsDirty,this),this.isNew=bind(this.isNew,this),this.setAsExisting=bind(this.setAsExisting,this),this.delete=bind(this.delete,this),this.save=bind(this.save,this),this._state=this._isExisting(a)?new d:new e,this.setValuesWith(new i(a))}return a.prototype._isExisting=function(a){return null!=a?a.id:void 0},a.prototype.save=function(a){return this._state.save(this,a).then(function(){return this})},a.prototype.delete=function(a){return this._state.delete(this,a)},a.prototype.setAsExisting=function(a){return this.id=a,this._state=new d},a.prototype.isNew=function(){return this._state.isNew()},a.prototype.setAsDirty=function(a){return null==a&&(a={}),this._state.setAsDirty(a)},a.prototype.setAsPristine=function(){return this._state.setAsPristine()},a.prototype.isDirty=function(){return this._state.isDirty()},a.prototype.rollback=function(){return this._state.rollback(this)},a.prototype.setValuesWith=function(a){return _.assign(_.assign(this,a),Object.getPrototypeOf(a))},a.prototype.updateValuesWith=function(a){return this.setValuesWith(a)},a.prototype.sendPost=function(a){return i.save(a,this.toDto()).$promise},a.prototype.sendPut=function(a){return i.update(a,this.toDto()).$promise},a.prototype.sendDelete=function(a){return i.delete(a,this).$promise},a.prototype.toDto=function(){return this},a}(),_.assign(h,i),h._build=function(a){return new this(a)},h.get=function(a){return i.get(a).$promise.then(function(a){return function(b){return a._build(b)}}(this))},h.query=function(a){return i.query(a).$promise.then(function(a){return function(b){return b.map(function(b){return a._build(b)})}}(this))},h}});var bind=function(a,b){return function(){return a.apply(b,arguments)}};rw.factory("CollectionWatcher",function(a,b){return function(){function c(a,b,c){this.scope=a,this.collection=b,this._getOrCreateResourceWatcher=bind(this._getOrCreateResourceWatcher,this),this._watchResource=bind(this._watchResource,this),this._saveResource=bind(this._saveResource,this),this._rollbackCollection=bind(this._rollbackCollection,this),this._rollbackResources=bind(this._rollbackResources,this),this._createResourceWatcher=bind(this._createResourceWatcher,this),this.createAndAddResourceWatcher=bind(this.createAndAddResourceWatcher,this),this.setAsDirty=bind(this.setAsDirty,this),this.watchCollection=bind(this.watchCollection,this),this.watch=bind(this.watch,this),this.isNew=bind(this.isNew,this),this.isDirty=bind(this.isDirty,this),this._deleteIfNecessary=bind(this._deleteIfNecessary,this),this.save=bind(this.save,this),this._removeNewElements=bind(this._removeNewElements,this),this.cancel=bind(this.cancel,this),this.resourceWatchers=this.collection.map(function(a){return function(b){return a._createResourceWatcher(b,c)}}(this)),this.hasChanges=!1,this.watchCollection()}return c.prototype.cancel=function(){return this._removeNewElements(this.collection),this._rollbackCollection(),this._rollbackResources()},c.prototype._removeNewElements=function(a){return _.remove(a,function(a){return function(a){return a.isNew()}}())},c.prototype.save=function(a,c){var d,e,f;return f=null==(d=(null!=c?c:{}).strict)||d,this.watchCollection(),this._deleteIfNecessary(),e=this.collection.map(function(b){return function(c){var d;return d=b._saveResource(a,c),f?d:d.then(function(a){return{success:!0,result:a}}).catch(function(a){return{success:!1,error:a}})}}(this)),this.hasChanges=!1,b.all(e)},c.prototype._deleteIfNecessary=function(){var a;return a=_.reject(this.previousState,function(a){return function(b){return _.includes(a.collection,b)}}(this)),a.forEach(function(a){return function(a){return a.delete()}}())},c.prototype.isDirty=function(){return this.hasChanges||_.some(this.collection,function(a){return function(a){return a.isDirty()}}())},c.prototype.isNew=function(){return _.some(this.collection,function(a){return function(a){return a.isNew()}}())},c.prototype.watch=function(){return this.watchCollection(),this.resourceWatchers.forEach(function(a){return function(a){return a.watch()}}())},c.prototype.watchCollection=function(){var a;return a=this.scope.$watchCollection(function(a){return function(){return a.collection}}(this),function(b){return function(c,d){if(c.length!==d.length)return b.setAsDirty(d),a()}}(this),!0)},c.prototype.setAsDirty=function(a){return this.previousState=a,this.hasChanges=!0},c.prototype.createAndAddResourceWatcher=function(a){var b;return b=this._createResourceWatcher(a),this.resourceWatchers.push(b),b},c.prototype._createResourceWatcher=function(b,c){return new a(this.scope,b,c)},c.prototype._rollbackResources=function(){return this.collection.forEach(function(a){return function(a){return a.rollback()}}()),this.watch()},c.prototype._rollbackCollection=function(){return _.assign(this.collection,this.previousState),this.hasChanges=!1},c.prototype._saveResource=function(a,b){return b.save(a).then(function(a){return function(){return a._watchResource(b)}}(this))},c.prototype._watchResource=function(a){return this._getOrCreateResourceWatcher(a).watch()},c.prototype._getOrCreateResourceWatcher=function(a){var b;return b=_.find(this.resourceWatchers,function(b){return b.resource===a}),b||(b=this.createAndAddResourceWatcher(a)),b},c}()});var bind=function(a,b){return function(){return a.apply(b,arguments)}};rw.factory("ResourceWatcher",function(){return function(){function a(a,b,c){var d;this.scope=a,this.watchedResource=b,d=(null!=c?c:{}).autoWatch,this.isNew=bind(this.isNew,this),this.isDirty=bind(this.isDirty,this),this.save=bind(this.save,this),this.cancel=bind(this.cancel,this),this.watch=bind(this.watch,this),null==d&&(d=!0),d&&this.watch()}return a.prototype.watch=function(){var a;return a=this.scope.$watch(function(a){return function(){return a.watchedResource}}(this),function(b){return function(c,d){if(c!==d)return b.watchedResource.setAsDirty(d),a()}}(this),!0)},a.prototype.cancel=function(){return this.watchedResource.rollback(),this.watch()},a.prototype.save=function(a){return this.watchedResource.save(a).then(this.watch)},a.prototype.isDirty=function(){return this.watchedResource.isDirty()},a.prototype.isNew=function(){return this.watchedResource.isNew()},a}()}),rw.constant("watcherConfig",{save:"Guardar",cancel:"Cancelar"}),rw.directive("watcher",function(a,b,c,d){var e;return e='<aside class="button-container">\n  <div ng-show="isDirty()">\n    <input type="submit" ng-value="saveLabel" class="btn btn-success"/><a href="" ng-click="cancel()" class="cancel-link">{{ cancelLabel }}</a>\n  </div>\n</aside>',{template:e,restrict:"E",replace:!0,scope:!0,controller:function(b,c){return this.addWatcher=function(a){return b.watcher=a},b.saveLabel=a.save,b.cancelLabel=a.cancel,b.cancel=function(){return b.watcher.cancel()},b.isDirty=function(){return b.watcher.isDirty()},b.isNew=function(){return b.watcher.isNew()},b.$on("save",function(a,c){return b.watcher.save(c)}),this}}}).directive("watchResource",function(a,b){return{restrict:"A",require:"^watcher",scope:!1,link:function(c,d,e,f){var g;return g=b(e.watchResource)(c),f.addWatcher(new a(c,g))}}}).directive("watchResourceCollection",function(a,b){return{restrict:"A",scope:!1,require:"^watcher",link:function(c,d,e,f){var g;return g=b(e.watchResourceCollection)(c),f.addWatcher(new a(c,g))}}}).directive("customWatch",function(a){return{restrict:"A",scope:!1,require:"^watcher",link:function(b,c,d,e){return e.addWatcher(a(d.customWatch)(b))}}}).directive("watcherSubmit",function(a){return{restrict:"A",require:"form",scope:!1,link:function(b,c,d,e){return e.attempt=!1,c.bind("submit",function(){if(e.attempt=!0,b.$$phase||b.$apply(),e.$valid)return b.$broadcast("save",a(d.watcherSubmit)(b))})}}});